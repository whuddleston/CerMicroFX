---
title: "LTO-Ni-R3-PCA"
author: "whh36"
date: "8/17/2020"
output: html_document
---

```{r setup, include=FALSE}
#SETUP OF LIBRARIES
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE) #set echo to FALSE to hide code
```

<!--
```{r}
r3densities %>%
  mutate(Label = substr(Labelfine, 1, 5)) %>%
  left_join(., fractSum, by = "Label") %>%
  filter(Ni.Vol.Corrected == 0.35) %>%
  filter(hrs == 5) %>%
  filter(Label != "WH13A") %>% #weird outlier
  select(x, density, Labelfine) %>%
  mutate(x = round(x, digits = 3)) %>%
  spread(., key = x, value = density) %>%
  select(-Labelfine) %>%
  PCA(scale.unit = TRUE)
```
-->

```{r}
prcomp.R3 <- r3densities %>%
  mutate(Label = substr(Labelfine, 1, 5)) %>%
  left_join(., fractSum, by = "Label") %>%
  filter(Ni.Vol.Corrected == 0.35) %>%
  filter(hrs == 5) %>%
  filter(Label != "WH13A") %>% #weird outlier
  filter(Labelfine != "WH06A/1000-5-35A0006.tiff") %>%
  filter(Labelfine != "WH06C/1000-5-35C0004.tiff") %>%
  select(x, density, Labelfine) %>%
  mutate(x = round(x, digits = 3)) %>%
  spread(., key = x, value = density) %>%
  select(-Labelfine) %>%
  prcomp(scale = TRUE)

fviz_eig(prcomp.R3, addlabels = TRUE)

#fviz_pca_ind(prcomp.R3, col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE)

loadingplot(prcomp.R3, comps = 1:3, legendpos = "right", labels = 'numbers', pretty.xlabels = TRUE, #xlab = 'Time (s)',
            ylab = 'Loading Value')

prcomp.R3.fractSum <- df_particles_fine %>%
  #same filters as used for PCA BIG BIG BIG THIS IS WHERE I WILL GO WRONG
  filter(Ni.Vol.Corrected == 0.35) %>%
  filter(hrs == 5) %>%
  filter(Label != "WH13A") %>% #weird outlier
  filter(Labelfine != "WH06A/1000-5-35A0006.tiff") %>%
  filter(Labelfine != "WH06C/1000-5-35C0004.tiff") %>%
  select(Labelfine) %>%
  unique() %>%
  mutate(Label = substr(Labelfine, 1, 5)) %>%
  left_join(., fractSum, by = "Label")


prcomp.R3.fractSum$Temp <- as.factor(prcomp.R3.fractSum$Temp)

autoplot(prcomp.R3, data = prcomp.R3.fractSum,
         colour = "Temp",
         label = TRUE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic()

fviz_contrib(prcomp.R3, choice = "var", axes = 1)
fviz_contrib(prcomp.R3, choice = "var", axes = 2)

autoplot(prcomp.R3, 
         x = 2,
         y = 3,
         data = prcomp.R3.fractSum,
         colour = "Temp",
         label = TRUE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic()

autoplot(prcomp.R3, 
         x = 1,
         y = 3,
         data = prcomp.R3.fractSum,
         colour = "Temp",
         label = TRUE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic()
```


```{r}
prcomp.R3.Var = get_pca_ind(prcomp.R3)

prcomp.R3.Contrib = prcomp.R3.Var$contrib
prcomp.R3.Coord = as.data.frame(prcomp.R3.Var$coord)

prcomp.R3.Coord <- cbind(prcomp.R3.Coord, prcomp.R3.fractSum)

plot_ly(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.2, z = prcomp.R3.Coord$Dim.3, 
        color = prcomp.R3.Coord$Temp,
        colors = hue_pal()(5),
        type = 'scatter3d') %>%
  layout(title = 'PCs 1,2,3',
         scene = list(
           xaxis = list(title = "PC1"),
           yaxis = list(title = "PC2"),
           zaxis = list(title = "PC3")
         ))

plot_ly(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.2, z = prcomp.R3.Coord$Dim.4, 
        color = prcomp.R3.Coord$Temp,
        colors = hue_pal()(5),
        type = 'scatter3d') %>%
  layout(title = 'PCs 1,2,4',
         scene = list(
           xaxis = list(title = "PC1"),
           yaxis = list(title = "PC2"),
           zaxis = list(title = "PC4")
         ))

#plot3d(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.2, z = prcomp.R3.Coord$Dim.3)
#text3d(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.2, z = prcomp.R3.Coord$Dim.3, texts= rownames(prcomp.R3.Coord), col=4)

```



```{r}
prcomp.R3.pcsx <- data.frame()

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.min(PC1)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  filter(r3x > 0) %>%
  slice(which.max(PC1)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.min(PC2)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.max(PC2)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  filter(r3x > 0) %>%
  slice(which.min(PC3)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  filter(r3x < 0) %>%
  slice(which.max(PC3)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)


df_particles %>%
  filter(Label != "WH19A") %>%
  mutate(Label = substr(Label,0,4)) %>%
  #
  group_by(Label) %>%
  mutate(rstar = R3/mean(R3)) %>%
  #
  filter(Label != "WH15B") %>%
  filter(Area >= 0.005) %>%
  filter(hrs == 5) %>%
  filter(Label != "WH19") %>%
  filter(Ni.Vol.Corrected == 0.35) %>%
  ggplot() +
  geom_density_ridges(size = 1, aes(x = R3, y = Temp, group = Temp, 
                                    #color = black,
                                    fill = as.factor(Temp))) +
  #
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1], 
             color = "black", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2], color = "black") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3], 
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4], color = "red") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5], 
             color = "green", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6], color = "green") +
  #
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1], 
             y = 1250, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2], 
             y = 1200, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3], 
             y = 1150, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4], 
             y = 1100, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5], 
             y = 1050, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6], 
             y = 1000, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6],2))) +
  
  #
  scale_x_log10(sec.axis = sec_axis(~.^(1/3)*2, name = expression(D~'['*mu*m*']')),
                limits = c(0.0001, 10000),
                breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_y_continuous(breaks = c(700,800,900,1000,1100),
                     sec.axis = sec_axis(~., labels = NULL)) +
  
  #geom_hline(yintercept = 0, color = "White", size = 1.5) +
  theme_classic() +


  ylab("") +
  xlab(expression(R^3~'['*mu*m^3*']')) +
  #annotation_logticks(sides = "b") +
  guides(color = FALSE, fill = guide_legend(reverse = TRUE, title = expression(Temp~'['*degree*C*']'), 
                               #override.aes = list(size=4), 
                               title.theme = element_text(colour = "black",
                                                          #face = "bold",
                                                          size = 12))) +
  theme(axis.text.x = element_text(colour = "black", size = 16),
        axis.text.y = element_text(colour = "black", size = 16),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.line = element_line(colour = 'black', size = 1),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16),
        legend.text = element_text(colour="black", size = 12))
```

```{r}
#Comparison of R3 distributions for 1000C-5hrs-35Ni images used in PCA of R3 values

nine %>%
  filter(Ni.Vol.Corrected == 0.35) %>%
  filter(hrs == 5) %>%
  filter(Temp == 1000) %>% #Temperature of interest
  filter(Area >= 0.005) %>% #Noise reduction
  #
  #select(Labelfine) %>%
  #unique()
  #
  group_by(Labelfine) %>%
  #
  ggplot() +
  geom_density_ridges(size = 1, aes(x = R3, y = as.factor(Labelfine), group = Labelfine,
                                                 fill = as.factor(Label))) + 
  #
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1], 
             color = "black", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2], color = "black") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3], 
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4], color = "red") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5], 
             color = "green", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6], color = "green") +
  #
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1], 
             y = 1, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2], 
             y = 2, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3], 
             y = 3, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4], 
             y = 4, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5], 
             y = 5, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6], 
             y = 6, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6],2))) +
  #
  scale_x_log10(sec.axis = sec_axis(~.^(1/3)*2, name = expression(D~'['*mu*m*']')),
                limits = c(0.0001, 10000),
                breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  #scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic() +
  guides(fill = FALSE, colour = guide_legend(title = "Mag. [x]", reverse = TRUE,
                               #override.aes = list(size=4), 
                               title.theme = element_text(colour="black",
                                                          #face = "bold",
                                                          size = 12))) +
  ylab("") +
  xlab(expression(R^3~'['*mu*m^3*']')) +
  geom_hline(yintercept = 0, color = "White", size = 1.5) +
  #annotation_logticks() +
  #scale_fill_manual(values=c("#00BF7D", "#BF7D00", "#7C00BF", "#BF0041")) +
  theme(axis.text.x = element_text(colour = "black", size = 16),
        axis.text.y = element_text(colour = "black", size = 16),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.line = element_line(colour = 'black', size = 1),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16),
        legend.text = element_text(colour="black", size = 12))
```


```{r}
prcomp.R3.Ni <- r3densities %>%
  mutate(Label = substr(Labelfine, 1, 5)) %>%
  left_join(., fractSum, by = "Label") %>%
  #filter(Ni.Vol.Corrected == 0.35) %>%
  filter(Temp == 900) %>%
  filter(hrs == 5) %>%
  filter(Label != "WH13A") %>% #weird outlier
  select(x, density, Labelfine) %>%
  mutate(x = round(x, digits = 3)) %>%
  spread(., key = x, value = density) %>%
  select(-Labelfine) %>%
  prcomp(scale = TRUE)

fviz_eig(prcomp.R3.Ni, addlabels = TRUE)

loadingplot(prcomp.R3.Ni, comps = 1:3, legendpos = "right", labels = 'numbers', pretty.xlabels = TRUE, #xlab = 'Time (s)',
            ylab = 'Loading Value')

prcomp.R3.fractSum.Ni <- df_particles_fine %>%
  #same filters as used for PCA BIG BIG BIG THIS IS WHERE I WILL GO WRONG
  #filter(Ni.Vol.Corrected == 0.35) %>%
  filter(Temp == 900) %>%
  filter(hrs == 5) %>%
  #filter(Labelfine != "WH13A/LTO-35Ni0010.jpg") %>% #weird outlier
  select(Labelfine) %>%
  unique() %>%
  mutate(Label = substr(Labelfine, 1, 5)) %>%
  left_join(., fractSum, by = "Label") %>%
  filter(Label != "WH15B") %>%
  filter(Label != "WH13A")


prcomp.R3.fractSum.Ni$Ni.Vol.Corrected <- as.factor(prcomp.R3.fractSum.Ni$Ni.Vol.Corrected)

autoplot(prcomp.R3.Ni, data = prcomp.R3.fractSum.Ni,
         colour = "Ni.Vol.Corrected",
         label = FALSE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic()

autoplot(prcomp.R3.Ni, data = prcomp.R3.fractSum.Ni,
         colour = "Ni.Vol.Corrected",
         label = FALSE, frame = TRUE) +
  scale_x_continuous(limits = c(-0.15,0.025), sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic()

fviz_contrib(prcomp.R3.Ni, choice = "var", axes = 1)
fviz_contrib(prcomp.R3.Ni, choice = "var", axes = 2)
```

```{r}
prcomp.R3.pcsx.Ni <- data.frame()

prcomp.R3.pcsx.Ni <- as.data.frame(prcomp.R3.Ni$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.min(PC1)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx.Ni, .)

prcomp.R3.pcsx.Ni <- as.data.frame(prcomp.R3.Ni$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  filter(r3x > 0) %>%
  slice(which.max(PC1)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx.Ni, .)

prcomp.R3.pcsx.Ni <- as.data.frame(prcomp.R3.Ni$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  mutate(r3x = as.numeric(r3x)) %>%
  filter(r3x > -3) %>%
  filter(r3x < 1) %>%
  slice(which.min(PC2)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx.Ni, .)

prcomp.R3.pcsx.Ni <- as.data.frame(prcomp.R3.Ni$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.max(PC2)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx.Ni, .)

prcomp.R3.pcsx.Ni <- as.data.frame(prcomp.R3.Ni$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.min(PC3)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx.Ni, .)

prcomp.R3.pcsx.Ni <- as.data.frame(prcomp.R3.Ni$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.max(PC3)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx.Ni, .)


nifix <- function(z){
  if(z == 0.05) 1 else if(z == 0.1) 2 else if(z == 0.2) 3 else if(z == 0.24) 4 else if(z == 0.28) 5 else if(z == 0.35) 6 else if(z == 0.4) 7 else if(z == 0.5) 8
}

df_particles %>%
  mutate(Label = substr(Label,0,4)) %>%
  #
  group_by(Label) %>%
  mutate(rstar = R3/mean(R3)) %>%
  #
  mutate(ni2 = nifix(Ni.Vol.Corrected)) %>%
  #
  filter(Label != "WH15B") %>%
  filter(Area >= 0.005) %>%
  filter(Label != "WH19") %>%
  filter(Temp == 900) %>%
  filter(hrs == 5) %>%
  ggplot() +
  geom_density_ridges(size = 1, aes(x = R3, y = ni2-1, group = Ni.Vol.Corrected, 
                   fill = as.factor(Ni.Vol.Corrected))) + 
  #
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[1], 
             color = "black", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[2], 
             color = "black") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[3], 
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[4], 
             color = "red") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[5], 
             color = "green", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[6], 
             color = "green") +
  #
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[1], 
             y = 9, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[1],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[2], 
             y = 8, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[2],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[3], 
             y = 7, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[3],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[4], 
             y = 6, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[4],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[5], 
             y = 5, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[5],2))) +
  annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[6], 
             y = 4, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx.Ni))))[6],2))) +
  #
  scale_x_log10(sec.axis = sec_axis(~.^(1/3)*2, name = expression(D~'['*mu*m*']')),
                limits = c(0.0001, 10000),
                breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_y_continuous(breaks = c(0,1,2,3,4,5,6,7),
                     labels = c("0.05", "0.10", "0.20", "0.24", "0.28", "0.35", "0.40", "0.50"),
                     sec.axis = sec_axis(~., breaks = c(0,1,2,3,4,5,6,7), labels = NULL)) +
  #geom_hline(yintercept = 0, color = "White", size = 1.5) +
  theme_classic() +
  ylab("") +
  xlab(expression(R^3~'['*mu*m^3*']')) +
  #annotation_logticks(sides = "tb") +
  guides(colour = FALSE, fill = guide_legend(reverse = TRUE, title = "Ni Vol.", 
                               #override.aes = list(size=4), 
                               title.theme = element_text(colour = "black",
                                                          #face = "bold",
                                                          size = 12))) +
  theme(axis.text.x = element_text(colour = "black", size = 16),
        axis.text.y = element_text(colour = "black", size = 16),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.line = element_line(colour = 'black', size = 1),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16),
        legend.text = element_text(colour="black", size = 12))
```

```{r, eval=FALSE}
#cleanup

rm(prcomp.R3.fractSum)
rm(prcomp.R3.Var)
rm(prcomp.R3.Contrib)
rm(prcomp.R3.Coord)

rm(prcomp.R3)
rm(prcomp.R3.pcsx)

rm(prcomp.R3.fractSum.Ni)

rm(nifix)
rm(prcomp.R3.pcsx.Ni)
rm(prcomp.R3.Ni)
```




# PCA on all samples together

```{r}
#PCA on all samples together

prcomp.R3 <- r3densities %>%
  mutate(Label = substr(Labelfine, 1, 5)) %>%
  left_join(., fractSum, by = "Label") %>%
  #filter(Ni.Vol.Corrected == 0.35) %>%
  #filter(hrs == 5) %>%
  filter(Label != "WH13A") %>% #weird outlier
  filter(Label != "WH15B") %>%
  filter(Label != "WH21B") %>%
  filter(Labelfine != "WH06A/1000-5-35A0006.tiff") %>%
  filter(Labelfine != "WH06C/1000-5-35C0004.tiff") %>%
  #
  #filter(Labelfine != "WH32A/LTO-35Ni-900-50-A0002.tiff") %>%
  #filter(Labelfine != "WH31C/LTO28Ni900-50-C0004.tiff") %>%
  #filter(Labelfine != "WH31C/LTO28Ni900-50-C0006.tiff") %>%
  #
  select(x, density, Labelfine) %>%
  mutate(x = round(x, digits = 3)) %>%
  spread(., key = x, value = density) %>%
  select(-Labelfine) %>%
  prcomp(scale = TRUE)

fviz_eig(prcomp.R3, addlabels = TRUE)

#fviz_pca_ind(prcomp.R3, col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE)

loadingplot(prcomp.R3, comps = 1:4, legendpos = "right", labels = 'numbers', pretty.xlabels = TRUE, #xlab = 'Time (s)',
            ylab = 'Loading Value')

prcomp.R3.fractSum <- df_particles_fine %>%
  #same filters as used for PCA BIG BIG BIG THIS IS WHERE I WILL GO WRONG
  #filter(Ni.Vol.Corrected == 0.35) %>%
  #filter(hrs == 5) %>%
  filter(Label != "WH13A") %>% #weird outlier
  filter(Label != "WH15B") %>%
  filter(Label != "WH21B") %>%
  filter(Labelfine != "WH06A/1000-5-35A0006.tiff") %>%
  filter(Labelfine != "WH06C/1000-5-35C0004.tiff") %>%
  #
  #filter(Labelfine != "WH32A/LTO-35Ni-900-50-A0002.tiff") %>%
  #filter(Labelfine != "WH31C/LTO28Ni900-50-C0004.tiff") %>%
  #filter(Labelfine != "WH31C/LTO28Ni900-50-C0006.tiff") %>%
  #
  select(Labelfine) %>%
  unique() %>%
  mutate(Label = substr(Labelfine, 1, 5)) %>%
  left_join(., fractSum, by = "Label")


prcomp.R3.fractSum$Temp <- as.factor(prcomp.R3.fractSum$Temp)
prcomp.R3.fractSum$hrs <- as.factor(prcomp.R3.fractSum$hrs)
prcomp.R3.fractSum$Ni.Vol.Corrected <- as.factor(prcomp.R3.fractSum$Ni.Vol.Corrected)

autoplot(prcomp.R3, data = prcomp.R3.fractSum,
         colour = "Temp",
         shape = "hrs",
         label = FALSE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_shape_manual(values=c(16, 17, 0, 2)) + #hrs
  theme_classic()

autoplot(prcomp.R3, data = prcomp.R3.fractSum,
         colour = "hrs",
         label = FALSE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic()

autoplot(prcomp.R3, data = prcomp.R3.fractSum,
         colour = "Ni.Vol.Corrected",
         shape = "hrs",
         label = FALSE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_shape_manual(values=c(16, 17, 0, 2)) + #hrs
  theme_classic()

autoplot(prcomp.R3, 
         x = 1,
         y = 3,
         data = prcomp.R3.fractSum,
         colour = "hrs",
         label = FALSE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  theme_classic()

autoplot(prcomp.R3, 
         x = 1,
         y = 4,
         data = prcomp.R3.fractSum,
         colour = "Temp",
         shape = "hrs",
         label = FALSE, frame = TRUE) +
  scale_x_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  scale_shape_manual(values=c(16, 17, 0, 2)) + #hrs
  theme_classic()
```





```{r}
prcomp.R3.pcsx <- data.frame()

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.min(PC1)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  filter(r3x > 0) %>%
  slice(which.max(PC1)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.min(PC2)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  slice(which.max(PC2)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  filter(r3x > 0) %>%
  slice(which.min(PC3)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)

prcomp.R3.pcsx <- as.data.frame(prcomp.R3$rotation) %>%
  rownames_to_column(var = "r3x") %>%
  filter(r3x < 0) %>%
  slice(which.max(PC3)) %>%
  select(r3x) %>%
  rbind(prcomp.R3.pcsx, .)


df_particles_fine %>%
  filter(Label != "WH19A") %>%
  mutate(Label = substr(Label,0,4)) %>%
  #
  group_by(Label) %>%
  #
  filter(Label != "WH15B") %>%
  filter(Area >= 0.005) %>%
  filter(Label != "WH19") %>%
  ggplot() +
  geom_density_ridges(size = 1, aes(x = R3, y = as.factor(Ni.Vol.Corrected), group = Labelfine, 
                                    #color = black,
                                    fill = as.factor(Temp))) +
  #
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1], 
             color = "black", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2], color = "black") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3], 
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4], color = "red") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5], 
             color = "green", linetype = "dashed") +
  geom_vline(xintercept = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6], color = "green") +
  #
  # annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1], 
  #            y = 1250, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[1],2))) +
  # annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2], 
  #            y = 1200, fontface = 1, label = paste("PC1 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[2],2))) +
  # annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3], 
  #            y = 1150, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[3],2))) +
  # annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4], 
  #            y = 1100, fontface = 1, label = paste("PC2 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[4],2))) +
  # annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5], 
  #            y = 1050, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[5],2))) +
  # annotate("text", x = 10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6], 
  #            y = 1000, fontface = 1, label = paste("PC3 ", round(10^as.numeric(c(t(as.vector(prcomp.R3.pcsx))))[6],2))) +
  
  #
  scale_x_log10(sec.axis = sec_axis(~.^(1/3)*2, name = expression(D~'['*mu*m*']')),
                limits = c(0.0001, 10000),
                breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  #scale_y_continuous(sec.axis = sec_axis(~., labels = NULL)) +
  
  #geom_hline(yintercept = 0, color = "White", size = 1.5) +
  theme_classic() +


  ylab("") +
  xlab(expression(R^3~'['*mu*m^3*']')) +
  #annotation_logticks(sides = "b") +
  guides(color = FALSE, fill = guide_legend(reverse = TRUE, title = expression(Temp~'['*degree*C*']'), 
                               #override.aes = list(size=4), 
                               title.theme = element_text(colour = "black",
                                                          #face = "bold",
                                                          size = 12))) +
  theme(axis.text.x = element_text(colour = "black", size = 16),
        axis.text.y = element_text(colour = "black", size = 16),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.line = element_line(colour = 'black', size = 1),
        axis.title.x = element_text(colour = "black", size = 16),
        axis.title.y = element_text(colour = "black", size = 16),
        legend.text = element_text(colour="black", size = 12))
```

```{r}
prcomp.R3.Var = get_pca_ind(prcomp.R3)

prcomp.R3.Contrib = prcomp.R3.Var$contrib

prcomp.R3.Coord = as.data.frame(prcomp.R3.Var$coord)

prcomp.R3.Results <- cbind(select(prcomp.R3.Coord, 1:6), prcomp.R3.fractSum)

#View(prcomp.R3.Results)
```

```{r}
prcomp.R3.Var = get_pca_ind(prcomp.R3)

prcomp.R3.Contrib = prcomp.R3.Var$contrib
prcomp.R3.Coord = as.data.frame(prcomp.R3.Var$coord)


prcomp.R3.Coord <- prcomp.R3.Coord %>%
  select(1:10)
  

prcomp.R3.Coord <- cbind(prcomp.R3.Coord, prcomp.R3.fractSum) %>%
  mutate(perc = if_else(condAve > 0.5,1,0)) %>%
  mutate(condAve = log(condAve)) %>%
  mutate(stresso = stressf*exp((1.05-Th.Density/100)*coef(fracmodel)[2]*-1))

plot_ly(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.2, z = prcomp.R3.Coord$Dim.4, 
        color = prcomp.R3.Coord$Ni.Vol.Corrected,
        colors = hue_pal()(5),
        type = 'scatter3d') %>%
  layout(title = 'PCs 1,2,4',
         scene = list(
           xaxis = list(title = "PC1"),
           yaxis = list(title = "PC2"),
           zaxis = list(title = "PC4")
           ))

plot_ly(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.2, z = prcomp.R3.Coord$Dim.4, 
        color = prcomp.R3.Coord$Temp,
        colors = hue_pal()(5),
        type = 'scatter3d') %>%
  layout(title = 'PCs 1,2,4',
         scene = list(
           xaxis = list(title = "PC1"),
           yaxis = list(title = "PC2"),
           zaxis = list(title = "PC4")
           ))

plot_ly(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.2, z = prcomp.R3.Coord$Dim.4, 
        color = prcomp.R3.Coord$perc,
        colors = hue_pal()(2),
        type = 'scatter3d') %>%
  layout(title = 'PCs 1,2,4',
         scene = list(
           xaxis = list(title = "PC1"),
           yaxis = list(title = "PC2"),
           zaxis = list(title = "PC4")
           ))

plot_ly(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.3, z = prcomp.R3.Coord$Dim.4, 
        color = prcomp.R3.Coord$condAve,
        colors = hue_pal()(5),
        type = 'scatter3d') %>%
  layout(title = 'PCs 1,3,4 Conductivity',
         scene = list(
           xaxis = list(title = "PC1"),
           yaxis = list(title = "PC3"),
           zaxis = list(title = "PC4")
           ))

plot_ly(x = prcomp.R3.Coord$Dim.1, y = prcomp.R3.Coord$Dim.3, z = prcomp.R3.Coord$Dim.2, 
        color = prcomp.R3.Coord$stressf,
        colors = hue_pal()(5),
        type = 'scatter3d') %>%
  layout(title = 'PCs 1,3,2 Stress',
         scene = list(
           xaxis = list(title = "PC1"),
           yaxis = list(title = "PC3"),
           zaxis = list(title = "PC4")
           ))
```

```{r}
#sort to find outlier
prcomp.R3.Coord %>%
  select(Dim.3, Labelfine) %>%
  filter(Dim.3 > 60)
```
